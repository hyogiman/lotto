<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교육용 로또 - 관리자</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fef2f2;
            color: #dc2626;
        }

        /* 추첨 제어 패널 */
        .draw-control {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .draw-control h2 {
            color: #1f2937;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .draw-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .draw-status {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #0c4a6e;
        }

        /* 탭 시스템 */
        .tabs-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tabs-nav {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: #f1f5f9;
            color: #374151;
        }

        .tab-btn.active {
            background: white;
            color: #4f46e5;
            border-bottom: 3px solid #4f46e5;
        }

        .tab-content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 18px;
            font-weight: bold;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 게임 설정 스타일 */
        .position-setup {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #4f46e5;
        }

        .position-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #374151;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .option-input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-weight: 600;
            transition: border-color 0.3s ease;
        }

        .option-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .winning-code-display {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .winning-code {
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 4px;
        }

        .manual-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .manual-select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-weight: 600;
            background: white;
        }

        .manual-select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        /* 사용자 관리 스타일 */
        .add-user-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
            font-size: 14px;
        }

        .add-user-input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .add-user-input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .users-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .user-selection {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-number {
            padding: 4px 8px;
            background: #e0e7ff;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
            min-width: 30px;
            text-align: center;
        }

        .user-controls {
            display: flex;
            gap: 8px;
        }

        .user-info-display {
            font-weight: 600;
            color: #1f2937;
        }

        .user-details {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* 히스토리 스타일 */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .history-code {
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 2px;
        }

        .winner-badge {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
            display: inline-block;
        }

        .no-winner {
            color: #6b7280;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 40px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .save-indicator.show {
            transform: translateY(0);
        }

        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .add-user-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-group {
                width: 100%;
            }

            .tabs-nav {
                flex-wrap: wrap;
            }

            .tab-btn {
                flex: none;
                min-width: 150px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header-controls {
                justify-content: center;
            }

            .draw-buttons {
                flex-direction: column;
                align-items: center;
            }

            .options-grid,
            .manual-controls {
                grid-template-columns: repeat(2, 1fr);
            }

            .users-table,
            .history-table {
                font-size: 14px;
            }

            .users-table th,
            .users-table td,
            .history-table th,
            .history-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🎰 관리자 컨트롤 센터</h1>
            <div class="header-controls">
                <div id="connectionStatus" class="connection-status status-disconnected">
                    <div class="loading"></div>
                    Firebase 연결 중...
                </div>
                <a href="draw.html" target="_blank" class="btn btn-secondary">🎯 추첨 화면 열기</a>
            </div>
        </div>

        <!-- 추첨 제어 패널 -->
        <div class="draw-control">
            <h2>🎮 추첨 제어</h2>
            
            <div class="draw-status" id="drawStatusDisplay">
                추첨 대기 중 - 언제든지 추첨을 시작할 수 있습니다
            </div>

            <div class="draw-buttons">
                <button id="startDrawBtn" class="btn btn-primary btn-large">
                    🚀 추첨 시작
                </button>
                <button id="resetDrawBtn" class="btn btn-danger btn-large" disabled>
                    🔄 추첨 리셋
                </button>
            </div>
        </div>

        <!-- 탭 시스템 -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="settings">
                    ⚙️ 게임 설정
                </button>
                <button class="tab-btn" data-tab="users">
                    👥 사용자 관리
                </button>
                <button class="tab-btn" data-tab="history">
                    📊 당첨 히스토리
                </button>
            </div>

            <div class="tab-content">
                <!-- 게임 설정 탭 -->
                <div class="tab-pane active" id="settings">
                    <h3 style="margin-bottom: 25px; color: #1f2937; font-size: 1.5rem;">각 자리별 선택지 설정</h3>
                    <div id="positionsContainer">
                        <!-- 동적으로 생성됩니다 -->
                    </div>

                    <h3 style="margin: 40px 0 20px 0; color: #1f2937; font-size: 1.5rem;">당첨 번호 설정</h3>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="autoMode" name="drawMode" value="auto" checked>
                            <label for="autoMode">자동 모드 (랜덤 생성)</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="manualMode" name="drawMode" value="manual">
                            <label for="manualMode">수동 모드 (직접 설정)</label>
                        </div>
                    </div>

                    <div id="manualControls" style="display: none;">
                        <div class="manual-controls" id="manualSelectors"></div>
                    </div>

                    <div class="winning-code-display">
                        <div class="winning-code" id="currentWinningCode">? - ? - ? - ?</div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button id="generateBtn" class="btn btn-warning">🎲 새 번호 생성</button>
                        <button id="saveSettings" class="btn btn-primary">💾 설정 저장</button>
                    </div>
                </div>

                <!-- 사용자 관리 탭 -->
                <div class="tab-pane" id="users">
                    <h3 style="margin-bottom: 25px; color: #1f2937; font-size: 1.5rem;">새 사용자 등록</h3>
                    
                    <div class="add-user-form">
                        <div class="form-group">
                            <label for="newEmployeeId">사번</label>
                            <input type="text" id="newEmployeeId" class="add-user-input" placeholder="사번 입력">
                        </div>
                        <div class="form-group">
                            <label for="newUserName">성명</label>
                            <input type="text" id="newUserName" class="add-user-input" placeholder="성명 입력">
                        </div>
                        <div class="form-group">
                            <label for="newUserPosition">직위</label>
                            <input type="text" id="newUserPosition" class="add-user-input" placeholder="직위 입력">
                        </div>
                        <button id="addUserBtn" class="btn btn-success">➕ 추가</button>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>사용자 정보</th>
                                    <th>선택 번호</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="3" class="empty-state">등록된 사용자가 없습니다</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button id="clearAllUsers" class="btn btn-danger">🗑️ 모든 사용자 삭제</button>
                    </div>
                </div>

                <!-- 당첨 히스토리 탭 -->
                <div class="tab-pane" id="history">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="color: #1f2937; font-size: 1.5rem;">추첨 기록</h3>
                        <button id="clearHistory" class="btn btn-danger">🗑️ 히스토리 초기화</button>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>회차</th>
                                    <th>추첨일시</th>
                                    <th>당첨번호</th>
                                    <th>당첨자</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="4" class="empty-state">아직 추첨 이력이 없습니다</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 저장 완료 알림 -->
    <div id="saveIndicator" class="save-indicator">✅ 저장되었습니다!</div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>

    <script>
        // Firebase 설정 (정확한 Realtime Database URL 적용)
        const firebaseConfig = {
            apiKey: "AIzaSyDrqmIoWUU8woTQygNv6xaZAKrVW0QQP-s",
            authDomain: "lottohyogi.firebaseapp.com",
            databaseURL: "https://lottohyogi-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "lottohyogi",
            storageBucket: "lottohyogi.firebasestorage.app",
            messagingSenderId: "888081310953",
            appId: "1:888081310953:web:77ee3153201d427e84fc78",
            measurementId: "G-DKWEY3D575"
        };

        // Firebase 초기화
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            setTimeout(() => {
                document.getElementById('connectionStatus').innerHTML = `
                    <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;"></span>
                    Firebase 연결됨
                `;
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
            }, 1000);
        } catch (error) {
            console.log('Firebase 연결 오류:', error);
            document.getElementById('connectionStatus').innerHTML = `
                <span style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%; display: inline-block;"></span>
                오프라인 모드
            `;
        }

        // 전역 변수들
        let gameSettings = {
            positions: [
                ['1', '2', '3', '4'],
                ['A', 'B', 'C', 'D'],
                ['가', '나', '다', '라'],
                ['♠', '♥', '♦', '♣']
            ],
            winningCode: ['1', 'A', '가', '♠'],
            isAutoMode: true
        };

        let users = {};
        let drawHistory = [];
        let isDrawing = false;

        // DOM 요소들
        const positionsContainer = document.getElementById('positionsContainer');
        const manualControls = document.getElementById('manualControls');
        const manualSelectors = document.getElementById('manualSelectors');
        const currentWinningCode = document.getElementById('currentWinningCode');
        const usersTableBody = document.getElementById('usersTableBody');
        const historyTableBody = document.getElementById('historyTableBody');
        const saveIndicator = document.getElementById('saveIndicator');
        const drawStatusDisplay = document.getElementById('drawStatusDisplay');

        // 페이지 초기화
        function initializePage() {
            loadAllData();
            renderPositionInputs();
            renderManualSelectors();
            updateWinningCodeDisplay();
            setupEventListeners();
            setupTabs();
        }

        // 탭 시스템 설정
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // 모든 탭 버튼 비활성화
                    tabBtns.forEach(b => b.classList.remove('active'));
                    // 클릭된 탭 활성화
                    btn.classList.add('active');
                    
                    // 모든 탭 패널 숨김
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    // 해당 패널 표시
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // 추첨 제어 함수들
        function startDraw() {
            if (isDrawing) return;

            if (Object.keys(users).length === 0) {
                alert('등록된 사용자가 없습니다. 먼저 사용자를 등록해주세요.');
                return;
            }

            isDrawing = true;
            document.getElementById('startDrawBtn').disabled = true;
            document.getElementById('resetDrawBtn').disabled = false;
            drawStatusDisplay.textContent = '추첨 진행 중... draw.html에서 확인하세요!';

            // Firebase에 추첨 시작 신호 전송
            if (database) {
                database.ref('drawState').set({
                    isActive: true,
                    started: true,
                    timestamp: Date.now()
                });
            }

            // 자동 모드면 새 당첨 번호 생성
            if (gameSettings.isAutoMode) {
                generateWinningCode();
                saveAllData();
            }

            // 추첨 완료 감지 (Firebase에서)
            if (database) {
                database.ref('drawState/completed').on('value', (snapshot) => {
                    if (snapshot.val() === true && isDrawing) {
                        finishDraw();
                    }
                });
            } else {
                // 오프라인 모드에서는 12초 후 자동 완료
                setTimeout(finishDraw, 12000);
            }
        }

        function finishDraw() {
            isDrawing = false;
            document.getElementById('startDrawBtn').disabled = false;
            drawStatusDisplay.textContent = '추첨 완료! 당첨자를 확인하세요.';

            // 당첨자 찾기 및 히스토리 추가
            const winners = [];
            Object.entries(users).forEach(([userId, userData]) => {
                const userSelection = userData.selection;
                if (userSelection && userSelection.every((selection, index) => 
                    selection !== '?' && selection === gameSettings.winningCode[index]
                )) {
                    winners.push(`${userData.name} ${userData.position}`);
                }
            });

            // 히스토리에 추가
            const drawResult = {
                timestamp: Date.now(),
                winningCode: [...gameSettings.winningCode],
                winners: winners,
                totalParticipants: Object.keys(users).length
            };

            drawHistory.push(drawResult);
            renderHistoryTable();
            saveAllData();

            // 결과 알림
            setTimeout(() => {
                if (winners.length > 0) {
                    alert(`🎉 축하합니다!\n\n당첨자: ${winners.join(', ')}\n당첨번호: ${gameSettings.winningCode.join(' - ')}`);
                } else {
                    alert(`😢 당첨자가 없습니다.\n\n당첨번호: ${gameSettings.winningCode.join(' - ')}\n참여자: ${Object.keys(users).length}명`);
                }
            }, 1000);
        }

        function resetDraw() {
            if (isDrawing) return;

            if (confirm('추첨을 리셋하시겠습니까?')) {
                document.getElementById('resetDrawBtn').disabled = true;
                drawStatusDisplay.textContent = '추첨 대기 중 - 언제든지 추첨을 시작할 수 있습니다';

                // Firebase 리셋 신호
                if (database) {
                    database.ref('drawState').set({
                        isActive: false,
                        shouldReset: true,
                        completed: false,
                        timestamp: Date.now()
                    });
                }
            }
        }

        // 모든 데이터 로드
        function loadAllData() {
            if (!database) {
                // 오프라인 모드
                const savedSettings = localStorage.getItem('gameSettings');
                const savedUsers = localStorage.getItem('users');
                const savedHistory = localStorage.getItem('drawHistory');
                
                if (savedSettings) gameSettings = JSON.parse(savedSettings);
                if (savedUsers) users = JSON.parse(savedUsers);
                if (savedHistory) drawHistory = JSON.parse(savedHistory);
                
                updateAllDisplays();
                return;
            }

            // Firebase에서 로드
            database.ref().once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.gameSettings) gameSettings = data.gameSettings;
                    if (data.users) users = data.users;
                    if (data.drawHistory) drawHistory = data.drawHistory;
                }
                updateAllDisplays();
            });
        }

        // 모든 화면 업데이트
        function updateAllDisplays() {
            renderPositionInputs();
            renderManualSelectors();
            updateWinningCodeDisplay();
            updateModeSelection();
            renderUsersTable();
            renderHistoryTable();
        }

        // 각 자리별 입력 필드 렌더링
        function renderPositionInputs() {
            positionsContainer.innerHTML = '';
            
            gameSettings.positions.forEach((position, posIndex) => {
                const positionDiv = document.createElement('div');
                positionDiv.className = 'position-setup';
                positionDiv.innerHTML = `
                    <div class="position-title">${posIndex + 1}번째 자리</div>
                    <div class="options-grid">
                        ${position.map((option, optIndex) => `
                            <input type="text" 
                                   class="option-input" 
                                   value="${option}" 
                                   placeholder="선택지 ${optIndex + 1}"
                                   data-position="${posIndex}"
                                   data-option="${optIndex}">
                        `).join('')}
                    </div>
                `;
                positionsContainer.appendChild(positionDiv);
            });

            // 입력 필드 이벤트 리스너 추가
            positionsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('option-input')) {
                    const posIndex = parseInt(e.target.dataset.position);
                    const optIndex = parseInt(e.target.dataset.option);
                    gameSettings.positions[posIndex][optIndex] = e.target.value;
                    renderManualSelectors();
                }
            });
        }

        // 수동 선택 드롭다운 렌더링
        function renderManualSelectors() {
            manualSelectors.innerHTML = '';
            
            gameSettings.positions.forEach((position, posIndex) => {
                const select = document.createElement('select');
                select.className = 'manual-select';
                select.dataset.position = posIndex;
                
                position.forEach((option) => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    optionElement.selected = gameSettings.winningCode[posIndex] === option;
                    select.appendChild(optionElement);
                });
                
                select.addEventListener('change', (e) => {
                    gameSettings.winningCode[posIndex] = e.target.value;
                    updateWinningCodeDisplay();
                });
                
                manualSelectors.appendChild(select);
            });
        }

        // 당첨 번호 표시 업데이트
        function updateWinningCodeDisplay() {
            currentWinningCode.textContent = gameSettings.winningCode.join(' - ');
        }

        // 모드 선택 업데이트
        function updateModeSelection() {
            document.getElementById('autoMode').checked = gameSettings.isAutoMode;
            document.getElementById('manualMode').checked = !gameSettings.isAutoMode;
            manualControls.style.display = gameSettings.isAutoMode ? 'none' : 'block';
            document.getElementById('generateBtn').style.display = gameSettings.isAutoMode ? 'block' : 'none';
        }

        // 사용자 테이블 렌더링
        function renderUsersTable() {
            const tbody = usersTableBody;
            
            if (Object.keys(users).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">등록된 사용자가 없습니다</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(users).map(([userId, userData]) => {
                const selection = userData.selection || ['?', '?', '?', '?'];
                return `
                    <tr>
                        <td>
                            <div class="user-info-display">${userData.name} ${userData.position}</div>
                            <div class="user-details">사번: ${userData.employeeId}</div>
                        </td>
                        <td>
                            <div class="user-selection">
                                ${selection.map((num, idx) => `
                                    <select class="user-number" onchange="updateUserSelection('${userId}', ${idx}, this.value)" ${selection.includes('?') ? '' : 'disabled'}>
                                        <option value="?">${num === '?' ? '?' : num}</option>
                                        ${gameSettings.positions[idx].map(option => 
                                            `<option value="${option}" ${num === option ? 'selected' : ''}>${option}</option>`
                                        ).join('')}
                                    </select>
                                `).join('')}
                            </div>
                        </td>
                        <td>
                            <div class="user-controls">
                                <button class="btn btn-warning btn-small" onclick="randomizeUserSelection('${userId}')" ${selection.includes('?') ? '' : 'disabled'}>🎲</button>
                                <button class="btn btn-success btn-small" onclick="unlockUserSelection('${userId}')" ${selection.includes('?') ? 'disabled' : ''}>🔓</button>
                                <button class="btn btn-danger btn-small" onclick="removeUser('${userId}')">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 히스토리 테이블 렌더링
        function renderHistoryTable() {
            const tbody = historyTableBody;
            
            if (drawHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">아직 추첨 이력이 없습니다</td></tr>';
                return;
            }

            tbody.innerHTML = drawHistory.map((draw, index) => `
                <tr>
                    <td><strong>${drawHistory.length - index}회</strong></td>
                    <td>${new Date(draw.timestamp).toLocaleString('ko-KR')}</td>
                    <td><span class="history-code">${draw.winningCode.join(' - ')}</span></td>
                    <td>
                        ${draw.winners.length > 0 
                            ? draw.winners.map(winner => `<span class="winner-badge">${winner}</span>`).join(' ')
                            : '<span class="no-winner">당첨자 없음</span>'
                        }
                    </td>
                </tr>
            `).reverse().join('');
        }

        // 새 사용자 추가 (수정된 버전)
        function addUser() {
            const employeeId = document.getElementById('newEmployeeId').value.trim();
            const name = document.getElementById('newUserName').value.trim();
            const position = document.getElementById('newUserPosition').value.trim();

            if (!employeeId || !name || !position) {
                alert('모든 정보를 입력하세요.');
                return;
            }

            if (Object.values(users).some(user => user.employeeId === employeeId)) {
                alert('이미 존재하는 사번입니다.');
                return;
            }

            if (Object.values(users).some(user => user.name === name)) {
                alert('이미 존재하는 사용자 이름입니다.');
                return;
            }

            const userId = 'user_' + employeeId;
            users[userId] = {
                employeeId: employeeId,
                name: name,
                position: position,
                selection: ['?', '?', '?', '?'],
                timestamp: Date.now()
            };

            document.getElementById('newEmployeeId').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPosition').value = '';
            
            renderUsersTable();
            saveAllData();
        }

        // 사용자 선택 번호 업데이트
        function updateUserSelection(userId, position, value) {
            if (users[userId]) {
                users[userId].selection[position] = value;
                saveAllData();
            }
        }

        // 사용자 번호 랜덤 생성
        function randomizeUserSelection(userId) {
            if (users[userId]) {
                users[userId].selection = gameSettings.positions.map(position => 
                    position[Math.floor(Math.random() * position.length)]
                );
                renderUsersTable();
                saveAllData();
            }
        }

        // 사용자 선택 잠금 해제
        function unlockUserSelection(userId) {
            if (users[userId] && confirm('이 사용자의 선택을 다시 수정 가능하게 만드시겠습니까?')) {
                users[userId].selection = ['?', '?', '?', '?'];
                renderUsersTable();
                saveAllData();
            }
        }

        // 사용자 삭제
        function removeUser(userId) {
            if (confirm('이 사용자를 삭제하시겠습니까?')) {
                delete users[userId];
                renderUsersTable();
                saveAllData();
            }
        }

        // 모든 사용자 삭제
        function clearAllUsers() {
            if (confirm('모든 사용자를 삭제하시겠습니까?')) {
                users = {};
                renderUsersTable();
                saveAllData();
            }
        }

        // 히스토리 초기화
        function clearHistory() {
            if (confirm('모든 추첨 히스토리를 삭제하시겠습니까?')) {
                drawHistory = [];
                renderHistoryTable();
                saveAllData();
            }
        }

        // 랜덤 당첨 번호 생성
        function generateWinningCode() {
            gameSettings.winningCode = gameSettings.positions.map(position => 
                position[Math.floor(Math.random() * position.length)]
            );
            updateWinningCodeDisplay();
            renderManualSelectors();
        }

        // 모든 데이터 저장
        function saveAllData() {
            const allData = {
                gameSettings: gameSettings,
                users: users,
                drawHistory: drawHistory
            };

            if (database) {
                database.ref().set(allData)
                    .then(() => {
                        showSaveIndicator();
                    })
                    .catch(error => {
                        console.error('저장 오류:', error);
                        alert('데이터 저장에 실패했습니다.');
                    });
            } else {
                // 오프라인 모드
                localStorage.setItem('gameSettings', JSON.stringify(gameSettings));
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('drawHistory', JSON.stringify(drawHistory));
                showSaveIndicator();
            }
        }

        // 저장 완료 알림 표시
        function showSaveIndicator() {
            saveIndicator.classList.add('show');
            setTimeout(() => {
                saveIndicator.classList.remove('show');
            }, 2000);
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 모드 변경
            document.querySelectorAll('input[name="drawMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    gameSettings.isAutoMode = e.target.value === 'auto';
                    updateModeSelection();
                });
            });

            // 추첨 제어 버튼들
            document.getElementById('startDrawBtn').addEventListener('click', startDraw);
            document.getElementById('resetDrawBtn').addEventListener('click', resetDraw);

            // 게임 설정 버튼들
            document.getElementById('generateBtn').addEventListener('click', generateWinningCode);
            document.getElementById('saveSettings').addEventListener('click', () => saveAllData());

            // 사용자 관리 버튼들
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('clearAllUsers').addEventListener('click', clearAllUsers);

            // 히스토리 관리 버튼
            document.getElementById('clearHistory').addEventListener('click', clearHistory);

            // 엔터키 처리 (사용자 등록)
            ['newEmployeeId', 'newUserName', 'newUserPosition'].forEach((id, index, array) => {
                document.getElementById(id).addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (index < array.length - 1) {
                            document.getElementById(array[index + 1]).focus();
                        } else {
                            addUser();
                        }
                    }
                });
            });
        }

        // 전역 함수들 (HTML에서 직접 호출되는 함수들)
        window.updateUserSelection = updateUserSelection;
        window.randomizeUserSelection = randomizeUserSelection;
        window.unlockUserSelection = unlockUserSelection;
        window.removeUser = removeUser;

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
